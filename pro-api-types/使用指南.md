# JLCEDA Pro API 使用指南

## 快速开始

### 1. 安装依赖

```bash
npm install @jlceda/pro-api-types
```

### 2. 基本使用

在扩展代码中引入 API：

```typescript
import type { EDA } from '@jlceda/pro-api-types';

// EDA 全局对象已由嘉立创 EDA 注入
declare const eda: EDA;
```

### 3. 常用示例

#### 获取当前工程信息

```typescript
async function getCurrentProject() {
	const projectInfo = await eda.dmt_Project.getCurrentProjectInfo();
	if (projectInfo) {
		console.log('工程名称:', projectInfo.projectFriendlyName);
		console.log('工程UUID:', projectInfo.uuid);
	}
}
```

#### 创建原理图图页

```typescript
async function createSchematicPage() {
	// 获取当前原理图
	const schematic = await eda.dmt_Schematic.getCurrentSchematicInfo();
	if (schematic) {
		// 创建新图页
		const pageUuid = await eda.dmt_Schematic.createSchematicPage(schematic.uuid);
		if (pageUuid) {
			console.log('成功创建图页:', pageUuid);
		}
	}
}
```

#### 在 PCB 中添加直线

```typescript
async function addLineOnPCB() {
	// 创建直线图元
	const line = await eda.pcb_PrimitiveLine.create(
		0, // startX
		0, // startY
		1000, // endX (单位: mil)
		1000, // endY
		10, // lineWidth
		1, // layer (顶层)
	);

	if (line) {
		console.log('成功添加直线，ID:', line.getState_PrimitiveId());
	}
}
```

#### 获取原理图所有器件

```typescript
async function getAllComponents() {
	const components = await eda.sch_Primitive.getAllComponents();
	console.log(`原理图中共有 ${components.length} 个器件`);

	for (const component of components) {
		const designator = component.getState_Designator();
		const name = component.getState_Name();
		console.log(`器件: ${designator} - ${name}`);
	}
}
```

#### 导出 PCB Gerber 文件

```typescript
async function exportGerber() {
	const result = await eda.pcb_ManufactureData.exportGerber({
		outputDir: '/path/to/output',
		format: 'RS274X',
		units: 'MM',
	});

	if (result.success) {
		console.log('Gerber 导出成功！');
	}
}
```

#### 监听图元变更事件

```typescript
// 监听 PCB 图元变更
eda.pcb_Event.onPrimitiveChange((event) => {
	console.log('图元变更:', event.type);
	console.log('变更的图元:', event.primitives);
});

// 监听原理图图元变更
eda.sch_Event.onPrimitiveChange((event) => {
	console.log('原理图图元变更:', event.type);
});
```

#### 搜索库中的器件

```typescript
async function searchDevice() {
	// 搜索电阻
	const devices = await eda.lib_Device.search('电阻');

	console.log(`找到 ${devices.length} 个相关器件`);

	devices.forEach((device) => {
		console.log(`名称: ${device.name}`);
		console.log(`描述: ${device.description}`);
	});
}
```

#### 使用立创 C 编号获取器件

```typescript
async function getDeviceByLcscId() {
	// 单个查询
	const device = await eda.lib_Device.getByLcscIds('C17414');
	if (device) {
		console.log('器件名称:', device.name);
	}

	// 批量查询
	const devices = await eda.lib_Device.getByLcscIds(['C17414', 'C17415', 'C17416']);
	console.log(`查询到 ${devices.length} 个器件`);
}
```

#### 显示消息提示

```typescript
// 信息消息
eda.sys_Message.info('操作成功！');

// 警告消息
eda.sys_Message.warning('请注意检查');

// 错误消息
eda.sys_Message.error('操作失败');

// 成功消息
eda.sys_Message.success('保存成功！');
```

#### 打开文件选择对话框

```typescript
async function selectFile() {
	const result = await eda.sys_Dialog.showOpenDialog({
		title: '选择文件',
		filters: [
			{ name: 'JSON文件', extensions: ['json'] },
			{ name: '所有文件', extensions: ['*'] },
		],
		properties: ['openFile'],
	});

	if (result && result.filePaths.length > 0) {
		console.log('选择的文件:', result.filePaths[0]);
	}
}
```

#### 读写本地存储

```typescript
// 保存数据
await eda.sys_Storage.set('myKey', { value: 'hello' });

// 读取数据
const data = await eda.sys_Storage.get('myKey');
console.log(data); // { value: 'hello' }

// 删除数据
await eda.sys_Storage.remove('myKey');
```

## API 模块说明

### DMT - 文档树

管理工程、板子、原理图、PCB、面板等文档结构。

**核心类:**

- `DMT_Project` - 工程管理
- `DMT_Board` - 板子管理
- `DMT_Schematic` - 原理图管理
- `DMT_Pcb` - PCB 管理
- `DMT_EditorControl` - 编辑器控制

### LIB - 综合库

管理器件、符号、封装、3D模型等库资源。

**核心类:**

- `LIB_Device` - 器件管理
- `LIB_Symbol` - 符号管理
- `LIB_Footprint` - 封装管理
- `LIB_LibrariesList` - 库列表

### PCB - PCB编辑

PCB 文档操作和图元绘制。

**核心类:**

- `PCB_Document` - 文档操作
- `PCB_Primitive*` - 各类图元操作
- `PCB_Layer` - 图层管理
- `PCB_Net` - 网络管理

### SCH - 原理图

原理图文档操作和图元绘制。

**核心类:**

- `SCH_Document` - 文档操作
- `SCH_Primitive*` - 各类图元操作
- `SCH_Netlist` - 网表管理

### SYS - 系统

系统级功能，包括 UI 交互、文件管理、网络通信等。

**核心类:**

- `SYS_Dialog` - 对话框
- `SYS_FileSystem` - 文件系统
- `SYS_Message` - 消息提示
- `SYS_Storage` - 本地存储

## 注意事项

### Beta API

标记为 ⚠️ **Beta** 的 API 处于测试阶段，可能会在后续版本中发生变更，请谨慎使用。

### 异步操作

大部分 API 都是异步的，返回 `Promise`，请使用 `async/await` 或 `.then()` 处理。

### 单位说明

- **原理图/符号**: 坐标单位为 0.01inch
- **PCB/封装**: 坐标单位为 mil (千分之一英寸)
- 使用 `SYS_Unit` 类进行单位转换

### 错误处理

API 操作失败时通常返回 `undefined` 或 `false`，请务必检查返回值：

```typescript
const result = await eda.dmt_Board.createBoard();
if (!result) {
  eda.sys_Message.error('创建板子失败');
  return;
}
```

## 更多资源

- [API 完整文档](./README.md)
- [嘉立创 EDA 官网](https://pro.lceda.cn/)
- [扩展开发文档](https://docs.lceda.cn/)

## 常见问题

### Q: 如何获取当前打开的文档？

```typescript
const docInfo = await eda.dmt_SelectControl.getCurrentDocumentInfo();
```

### Q: 如何切换到指定文档？

```typescript
await eda.dmt_EditorControl.activateDocument(tabId);
```

### Q: 如何保存文档？

```typescript
// 保存原理图
await eda.sch_Document.save();

// 保存 PCB
await eda.pcb_Document.save();
```

### Q: 如何获取所有图层？

```typescript
const layers = await eda.pcb_Layer.getAllLayers();
```

### Q: 如何进行 DRC 检查？

```typescript
// PCB DRC
const result = await eda.pcb_Drc.run();

// 原理图 DRC
const result = await eda.sch_Drc.run();
```
